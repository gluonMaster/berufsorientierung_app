# Обновление уже задеплоенного проекта: «Время окончания события + отзывы»

Этот мануал описывает, как **обновить уже работающий (production) деплой** приложения на Cloudflare Workers так, чтобы в проде появились новые функции, добавленные промптами `COPILOT_PROMPT_01_EVENT_END_TIME.md` → `COPILOT_PROMPT_06_PUBLIC_REVIEWS_PAGES.md`.

Базовый (первичный) деплой и настройка Cloudflare (D1/R2/Secrets/DNS/Cron) описаны в `docs/development/DEPLOYMENT.md`. Здесь — именно **update-процедура**.

---

## Что изменилось (кратко)

1. В D1 добавляется:

- колонка `events.end_date` (миграция `migrations/0005_add_event_end_date.sql`)
- таблицы `review_public_links` и `reviews` (миграция `migrations/0006_add_reviews.sql`)

2. В приложении появляется:

- форма отзыва для пользователя из ЛК по прошедшим/заканчивающимся событиям
- модерация отзывов админом (`/admin/reviews`)
- публичные ссылки на форму отзыва (без авторизации)
- публичный вывод принятых отзывов: блок на главной + страница `/reviews`

---

## Перед началом (важно)

1. Убедитесь, что вы деплоите **ту же самую** инсталляцию (тот же Cloudflare аккаунт, тот же Worker, та же D1).

- имя Worker: `berufsorientierung-app` (см. `wrangler.toml`)
- имя D1 базы: `berufsorientierung-db` (см. `wrangler.toml`)

2. Миграции ниже **аддитивные** (добавляют колонку/таблицы) и не должны ломать существующие данные, но всё равно сделайте **бэкап**.

3. Команды в примерах предполагают, что вы запускаете их из корня репозитория.

---

## 1) Подготовка окружения (если ещё не настроено на этом ПК)

Если вы уже деплоили по `docs/development/DEPLOYMENT.md`, этот раздел, скорее всего, можно пропустить.

### Минимум

- Node.js 18+
- Git
- Wrangler CLI v4+

Проверки:

```bash
node -v
npm -v
wrangler -v
```

Логин в Cloudflare (один раз на машине/профиле):

```bash
wrangler login
```

---

## 2) Забрать свежий код

Перейдите в папку проекта и обновите ветку (пример для `main`):

```bash
git pull origin main
```

Установите зависимости:

```bash
npm install
```

Рекомендуемая проверка (не обязательна, но полезна перед продом):

```bash
npm test
```

---

## 3) Сделать бэкап production D1 (рекомендуется)

### macOS / Linux (bash)

```bash
wrangler d1 export berufsorientierung-db --remote --output=backup-$(date +%Y%m%d-%H%M).sql
```

### Windows (PowerShell)

```powershell
wrangler d1 export berufsorientierung-db --remote --output=("backup-{0}.sql" -f (Get-Date -Format "yyyyMMdd-HHmm"))
```

Проверьте, что рядом появился файл `backup-*.sql` и он не пустой.

---

## 4) Применить миграции к production D1

В этой фиче появились **две новые миграции**, их важно выполнить **по порядку**:

1. `migrations/0005_add_event_end_date.sql`
2. `migrations/0006_add_reviews.sql`

Команды:

```bash
wrangler d1 execute berufsorientierung-db --remote --file=./migrations/0005_add_event_end_date.sql
wrangler d1 execute berufsorientierung-db --remote --file=./migrations/0006_add_reviews.sql
```

### Быстрая проверка, что миграции применились

Проверить, что у `events` есть `end_date`:

```bash
wrangler d1 execute berufsorientierung-db --remote --command="PRAGMA table_info(events);"
```

Проверить, что таблицы отзывов создались:

```bash
wrangler d1 execute berufsorientierung-db --remote --command="SELECT name FROM sqlite_master WHERE type='table' AND name IN ('reviews','review_public_links');"
```

---

## 5) Деплой кода на Cloudflare Workers

Собрать и задеплоить:

```bash
npm run deploy
```

Эквивалентно:

```bash
npm run build
wrangler deploy
```

---

## 6) После деплоя: важные действия в админке

### 6.1. Заполните `end_date` у событий

Новая функциональность отзывов и часть админских действий (например, генерация публичной ссылки) опираются на `end_date`.

Что сделать:

- в админке откройте события, у которых вы хотите собирать отзывы
- проставьте **время окончания** (`end_date`)
- сохраните

Примечание: публикация события теперь требует `end_date` (то есть если вы попробуете перепубликовать событие без `end_date`, получите ошибку).

### 6.2. Проверьте модерацию

Страница админа для модерации: `/admin/reviews`

- новые отзывы попадают со статусом `pending`
- админ может `Approve / Reject` по одному
- есть `Approve All / Reject All` (для очереди `pending`)

---

## 7) Как проверить новый функционал «в боевых условиях»

Ниже — практичный сценарий проверки в production (желательно сначала на тестовом событии).

### 7.1. Проверка отзывов из личного кабинета (авторизованный пользователь)

1. Создайте тестовое событие и поставьте `end_date` так, чтобы окно отзывов уже было открыто.
   - окно начинается за **45 минут до `end_date`**
   - для быстрого теста можно поставить `end_date` на ближайшие 20–40 минут
2. Опубликуйте событие и запишитесь на него обычным пользователем
3. Зайдите этим пользователем в ЛК `/profile`
4. У нужного события должна появиться возможность оставить отзыв (или статус, если отзыв уже отправлен)
5. Отправьте отзыв (он попадёт в `pending`)

Ожидаемо:

- отзыв **не появляется публично** сразу
- появляется в очереди `/admin/reviews` у админа

### 7.2. Модерация и публикация

1. Админ открывает `/admin/reviews`
2. Одобряет (Approve) отзыв
3. Проверяет публичное отображение:
   - главная страница: блок последних 5 отзывов
   - страница `/reviews`: лента отзывов с пагинацией

Важно:

- если отзыв был отправлен как «анонимный», админ всё равно видит автора в админке, но на публичной странице имя скрывается

### 7.3. Проверка публичной ссылки (без авторизации)

1. Админ в `/admin/reviews` генерирует публичную ссылку на конкретное событие (с указанием `expires_at`)
2. Открывает ссылку в приватном режиме браузера / на телефоне (без логина)
3. Отправляет отзыв
4. Админ модерирует отзыв (Approve)
5. Отзыв появляется на главной и в `/reviews`

Ожидаемо:

- для публичных ссылок автор (user_id) не известен, админ не может сопоставить отзыв с пользователем

---

## 8) Типовые проблемы и диагностика

### 8.1. Не появляется кнопка «Оставить отзыв» в ЛК

Проверьте:

- у события заполнен `end_date`
- текущее время попадает в окно: `now >= end_date - 45 минут` и `now <= (end_date - 45 минут) + 7 дней`
- пользователь действительно записан на событие

### 8.2. Нельзя создать публичную ссылку

Проверьте:

- у события заполнен `end_date`
- `expires_at` не в прошлом
- `expires_at` не выходит за допустимые ограничения (срок действия задаётся админом и валидируется сервером)

### 8.3. Смотреть логи production Worker

```bash
wrangler tail
```

---

## 9) Откат (rollback)

Код можно откатить через Cloudflare (см. `docs/development/DEPLOYMENT.md`), но учтите:

- миграции D1 (колонка/таблицы) уже останутся в базе - это нормально, они аддитивные
- при откате кода на старую версию новые роуты/функции могут пропасть, но данные в D1 останутся

---

## 10) Выкат хотфиксов (исправления для публичных ссылок и окна отзывов)

Эти исправления **не требуют новых миграций D1** - достаточно обновить код Worker.

### Шаги

```bash
git pull origin main
npm install
# опционально (рекомендуется)
npm test
npm run deploy
```

### Проверка после деплоя

1) **Публичная ссылка**: сгенерируйте ссылку и откройте её - форма должна быть доступна **сразу после создания** и до `expires_at` (независимо от 7-дневного окна отзывов).
2) **Личный кабинет**: после наступления `end_date - 45 минут` кнопка «Оставить отзыв» должна **сразу** вести на форму отзыва (без «пустого клика»/мгновенного возврата на `/profile`).

---

## 11) Деплой изменений (постеры мероприятий + герб в футере) на уже задеплоенном сайте

Ниже — обновлённая, “без догадок”, инструкция именно для случая, когда проект уже в production и нужно выкатить только изменения из этого чата (постеры + герб), без попыток заново прогонять старые миграции.

Важно: если вы применили только промпты 8-12, то загрузка постера в админке может не работать из-за найденного несоответствия ключа FormData (это чинится отдельным хотфиксом `COPILOT_PROMPT_13_*`).

### 11.1) Обновить код

```bash
git pull origin main
npm ci
```

### 11.2) D1 (production): применить только изменение схемы для постеров

Единственное изменение схемы из этих промптов — колонка `events.poster_url` (см. `migrations/0007_add_event_poster_url.sql`).

1) Проверить, есть ли уже колонка `poster_url`:

```bash
wrangler d1 execute berufsorientierung-db --remote --command "PRAGMA table_info(events);"
```

2) Если `poster_url` **отсутствует**, применить только нужный SQL:

```bash
wrangler d1 execute berufsorientierung-db --remote --command "ALTER TABLE events ADD COLUMN poster_url TEXT;"
```

Почему так: `wrangler d1 migrations apply ... --remote` применяет "все непримененные" миграции. Если миграции 0001-0006 в production когда-то накатывались вручную/через UI (а не через wrangler), wrangler не знает их статуса и попытается начать с 0001, что приводит к ошибке `table users already exists`.

### 11.3) R2 (production): проверить конфигурацию для загрузки постеров

- `R2_BUCKET` - это binding, он задаётся в `wrangler.toml` секцией `[[r2_buckets]] ... binding = "R2_BUCKET"`. Если QR-коды/другие R2-фичи уже работали, значит здесь всё настроено.
- `R2_PUBLIC_URL` — это secret (базовый публичный URL вашего R2 bucket), он нужен для формирования `events.poster_url`.

Проверить secrets:

```bash
wrangler secret list
```

Если `R2_PUBLIC_URL` отсутствует — задать:

```bash
wrangler secret put R2_PUBLIC_URL
```

### 11.4) Задеплоить Worker

```bash
npm test
npm run deploy
```

### 11.5) Быстрая проверка после деплоя

- Футер: убедиться, что `/img/Signet_gruen.gif` открывается и картинка видна справа внизу футера.
- Постеры: `/admin/events` -> открыть событие -> загрузить постер (jpg/png/gif, до 5MB) -> проверить отображение в карточках на главной и на `/events`.

Если upload постера в админке не работает — примените хотфикс `COPILOT_PROMPT_13_EVENT_POSTER_ADMIN_UI_FIX_UPLOAD.md` (сейчас UI отправляет файл под одним ключом, а API читает другой).
