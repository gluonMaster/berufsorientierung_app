# CHANGELOG - Database Utilities (Users)

## Исправления от 2025-10-21

### ✅ Проблема 1: Архивация перед удалением

**Было:** `deleteUser()` сразу удаляла запись без архивирования  
**Стало:**

- Добавлена функция `archiveUser()` для сохранения минимальных данных в `deleted_users_archive`
- `deleteUser()` теперь автоматически вызывает `archiveUser()` перед удалением
- Архивируются: имя, фамилия, дата регистрации, дата удаления, список мероприятий

---

### ✅ Проблема 2: Формат дат

**Было:**

- Использовался `toISOString()` с миллисекундами и часовым поясом Z
- При чтении не нормализовались даты из БД (SQLite возвращает с пробелом вместо T)

**Стало:**

- Добавлена утилита `nowSql()` - возвращает `YYYY-MM-DDTHH:MM:SS` (без миллисекунд и Z)
- Добавлена утилита `normalizeTimestamp()` - конвертирует даты из БД:
  - Заменяет пробел на T
  - Убирает миллисекунды (.sss)
  - Убирает часовой пояс (Z)
- Все timestamps теперь в формате `YYYY-MM-DDTHH:MM:SS`

---

### ✅ Проблема 3: Строгая типизация (избегать `any`)

**Было:**

- `rowToUser(row: any)` - параметр any
- `const values: any[]` - массив any
- `(row: any) =>` в getUsersList - маппинг any
- `as any` в blockUser

**Стало:**

- Создан интерфейс `DBUserRow` для строк из БД (все поля типизированы)
- `rowToUser(row: DBUserRow)` - строгая типизация
- `const values: (string | number | null)[]` - типизированный массив
- Создан локальный интерфейс `DBUserListRow` в getUsersList
- Использование дженериков: `.first<DBUserRow>()`, `.all<DBUserRow>()`
- `as UserUpdateData` вместо `as any` в blockUser

---

### ✅ Проблема 4: blockUser не работал

**Было:**

- Поле `is_blocked` отсутствовало в `fieldMapping` функции `updateUser`
- При вызове `blockUser()` обновление не применялось

**Стало:**

- Добавлено `is_blocked` в `fieldMapping` функции `updateUser`
- Добавлено `parental_consent` в `fieldMapping` для полноты
- Добавлена специальная обработка boolean полей (конвертация в 0/1)
- blockUser теперь корректно работает через updateUser
- Добавлены поля `is_blocked` и `parental_consent` в интерфейс `UserUpdateData`

---

## Дополнительные улучшения

1. **Type guard:** добавлена функция `isDBUserRow()` (пока не используется, но готова для runtime проверок)

2. **Нормализация дат в getUsersList:** timestamps теперь нормализуются через `normalizeTimestamp()`

3. **Обновлена документация:**
   - Описан формат дат без миллисекунд
   - Добавлена функция `archiveUser()`
   - Указаны утилиты для работы с датами
   - Отмечено использование строгой типизации

4. **Экспорт:** добавлен `archiveUser` в `src/lib/server/db/index.ts`

---

## Результат

✅ Все функции используют **строгую типизацию** (без `any`)  
✅ Даты в **едином формате** `YYYY-MM-DDTHH:MM:SS`  
✅ **GDPR compliance** - автоматическая архивация перед удалением  
✅ **blockUser** корректно работает  
✅ Код соответствует требованиям ТЗ

---

## Тестирование

Рекомендуется протестировать:

1. Создание пользователя → проверить формат `created_at` и `updated_at`
2. Обновление через `blockUser()` → проверить что `is_blocked` изменяется
3. Удаление пользователя → проверить наличие записи в `deleted_users_archive`
4. Чтение пользователей → проверить что даты без миллисекунд и Z
