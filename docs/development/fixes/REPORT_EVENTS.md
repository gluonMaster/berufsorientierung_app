# –û—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö - Events Database Utilities

**–î–∞—Ç–∞:** 2025-10-22  
**–ó–∞–¥–∞—á–∞:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –≤ –º–æ–¥—É–ª–µ Events

---

## üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –£–¥–∞–ª–µ–Ω–∏–µ QR-–∫–æ–¥–æ–≤ –∏–∑ R2 –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è QR-–∫–æ–¥—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ R2 storage  
**–§–∞–π–ª:** `src/lib/server/db/events.ts:288`

### 2. ‚ùå updated_at –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ additional_fields

**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å–ª–æ–≤–∏–µ `if (updateFields.length > 1)` –ø—Ä–æ–ø—É—Å–∫–∞–ª–æ UPDATE –∑–∞–ø—Ä–æ—Å  
**–§–∞–π–ª:** `src/lib/server/db/events.ts:206-215`

### 3. ‚ö†Ô∏è –ü–∞—Ä–∞–º–µ—Ç—Ä cancelledBy –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä –æ–±—ä—è–≤–ª–µ–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å noUnusedParameters  
**–§–∞–π–ª:** `src/lib/server/db/events.ts:544`

---

## ‚úÖ –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ deleteEvent - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ QR-–∫–æ–¥–æ–≤

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–ª–µ–Ω –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `r2Bucket?: R2Bucket`
- –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è `qr_telegram_url` –∏ `qr_whatsapp_url`
- QR-–∫–æ–¥—ã —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ R2 —á–µ—Ä–µ–∑ —É—Ç–∏–ª–∏—Ç—É `deleteFilesByUrls()`
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —É–¥–∞–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –∏–∑ –ë–î

**–ö–æ–¥:**

```typescript
export async function deleteEvent(db: D1Database, id: number, r2Bucket?: R2Bucket): Promise<void> {
	// ...
	if (r2Bucket) {
		const qrUrls = [event.qr_telegram_url, event.qr_whatsapp_url].filter(
			(url): url is string => url !== null
		);
		if (qrUrls.length > 0) {
			const { deleteFilesByUrls } = await import('$lib/server/storage/r2');
			const deletedCount = await deleteFilesByUrls(r2Bucket, qrUrls);
			console.log(`Deleted ${deletedCount} QR codes from R2 for event ${id}`);
		}
	}
	// –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```typescript
await deleteEvent(db, eventId, platform.env.QR_CODES_BUCKET);
```

---

### 2. ‚úÖ updateEvent - –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ updated_at

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –£–¥–∞–ª–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ `if (updateFields.length > 1)`
- UPDATE –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–≤—Å–µ–≥–¥–∞**, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `updated_at`

**–ö–æ–¥ –î–û:**

```typescript
if (updateFields.length > 1) {
	const sql = `UPDATE events SET ${updateFields.join(', ')} WHERE id = ?`;
	const result = await db
		.prepare(sql)
		.bind(...values)
		.run();
	// ...
}
```

**–ö–æ–¥ –ü–û–°–õ–ï:**

```typescript
// –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ updated_at)
const sql = `UPDATE events SET ${updateFields.join(', ')} WHERE id = ?`;
const result = await db
	.prepare(sql)
	.bind(...values)
	.run();
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- `updated_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ `additional_fields`
- `updated_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –≤—ã–∑–æ–≤–µ `updateEvent()`

---

### 3. ‚úÖ cancelEvent - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ cancelledBy

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ `activity_log`
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è: ID –∞–¥–º–∏–Ω–∞, —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è, –¥–µ—Ç–∞–ª–∏ –æ—Ç–º–µ–Ω—ã

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**

```typescript
// –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞—É–¥–∏—Ç–∞
await db
	.prepare(
		`INSERT INTO activity_log (user_id, action_type, details, timestamp)
		VALUES (?, ?, ?, ?)`
	)
	.bind(
		cancelledBy,
		'event_cancelled',
		JSON.stringify({
			event_id: id,
			event_title: event.title_de,
			reason: reason,
		}),
		now
	)
	.run();
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –æ—Ç–º–µ–Ω—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
- GDPR compliance
- –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å `noUnusedParameters`

---

## üì¶ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

### 1. `src/lib/server/storage/r2.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Cloudflare R2 Storage

**–§—É–Ω–∫—Ü–∏–∏:**

- `deleteFileByUrl()` - –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ URL
- `deleteFilesByUrls()` - –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
- `uploadFile()` - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ R2
- `fileExists()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞

**–†–∞–∑–º–µ—Ä:** 127 —Å—Ç—Ä–æ–∫

---

### 2. `src/lib/server/storage/index.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç storage —É—Ç–∏–ª–∏—Ç

---

### 3. `docs/features/storage/R2.md`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è R2 —É—Ç–∏–ª–∏—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üìù –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### 1. `docs/database/events/README.md`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –û–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–∏–º–µ—Ä `deleteEvent()` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `r2Bucket`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `cancelEvent()`
- –†–∞—Å—à–∏—Ä–µ–Ω —Ä–∞–∑–¥–µ–ª "–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è" (3 –Ω–æ–≤—ã—Ö –ø—É–Ω–∫—Ç–∞)

---

### 2. `docs/database/events/CHANGELOG.md`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "2025-10-22 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)"
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö 3 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- –£–±—Ä–∞–Ω TODO –ø—É–Ω–∫—Ç –ø—Ä–æ QR-–∫–æ–¥—ã (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:

```
‚úÖ 13/13 —Ç–µ—Å—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã
‚úÖ 0 –æ—à–∏–±–æ–∫ TypeScript
‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:

- ‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è TypeScript
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ unit-—Ç–µ—Å—Ç—ã –Ω–µ —Å–ª–æ–º–∞–ª–∏—Å—å
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è R2Bucket –¥–æ–±–∞–≤–ª–µ–Ω–∞

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –ú–µ—Ç—Ä–∏–∫–∞              | –ó–Ω–∞—á–µ–Ω–∏–µ |
| -------------------- | -------- |
| –ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤      | 5        |
| –°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤       | 4        |
| –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ | ~200     |
| –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º   | 3        |
| –ù–æ–≤—ã—Ö —É—Ç–∏–ª–∏—Ç         | 4        |

---

## üéØ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–º–ø—Ç—É

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ                              | –°—Ç–∞—Ç—É—Å         |
| --------------------------------------- | -------------- |
| deleteEvent —É–¥–∞–ª—è–µ—Ç QR-–∫–æ–¥—ã –∏–∑ R2       | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| updateEvent –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç updated_at | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  |
| cancelledBy –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞     | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Prepared statements                     | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ   |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫                        | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞   |
| TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è                    | ‚úÖ –ü–æ–ª–Ω–∞—è      |
| –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º                  | ‚úÖ –í–µ–∑–¥–µ       |

---

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### deleteEvent

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** ‚úÖ –ü–æ–ª–Ω–∞—è  
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä `r2Bucket` –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π

```typescript
// –°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
await deleteEvent(db, eventId);

// –ù–æ–≤—ã–π –∫–æ–¥ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–¥–∞–ª–µ–Ω–∏–µ–º QR
await deleteEvent(db, eventId, r2Bucket);
```

### updateEvent

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** ‚úÖ –ü–æ–ª–Ω–∞—è  
**–ü—Ä–∏—á–∏–Ω–∞:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏, API –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è

### cancelEvent

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** ‚úÖ –ü–æ–ª–Ω–∞—è  
**–ü—Ä–∏—á–∏–Ω–∞:** –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, API –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è

---

## üìå –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR-–∫–æ–¥–æ–≤** (`src/lib/server/storage/qr.ts`)
2. ‚è≥ **–î–æ–±–∞–≤–∏—Ç—å email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
3. ‚è≥ **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–∞—Å—Å–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç** –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π

---

## ‚ú® –ò—Ç–æ–≥–æ

–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–æ–º–ø—Ç—É:

- ‚úÖ QR-–∫–æ–¥—ã —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ `updated_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞
- ‚úÖ `cancelledBy` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å R2
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

**–ú–æ–¥—É–ª—å Events –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø—Ä–æ–º–ø—Ç–∞! üéâ**
