# Newsletter Batching Fix

**–î–∞—Ç–∞:** 11 –Ω–æ—è–±—Ä—è 2025  
**–ö–∞—Ç–µ–≥–æ—Ä–∏—è:** Email / Newsletter  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–í `src/routes/api/admin/newsletter/send/+server.ts` –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **—Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–∏–Ω–≥–∞** —Å –∂—ë—Å—Ç–∫–æ –ø—Ä–æ—à–∏—Ç—ã–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏:

```typescript
const EMAIL_BULK_CHUNK = 50; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏—Å–µ–º –≤ –æ–¥–Ω–æ–º –±–∞—Ç—á–µ
const EMAIL_BULK_PAUSE_MS = 1000; // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
```

**–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:**

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏:** –í –º–æ–¥—É–ª–µ `$lib/server/email/index.ts` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è `sendBulkEmails()`, –∫–æ—Ç–æ—Ä–∞—è:
   - –ë–µ—Ä—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ `env` (EMAIL_BULK_CHUNK, EMAIL_BULK_PAUSE_MS)
   - –ò–º–µ–µ—Ç –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã: 50 –ø–∏—Å–µ–º —Å –ø–∞—É–∑–æ–π **60 —Å–µ–∫—É–Ω–¥**
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑—É–µ—Ç –±–∞—Ç—á–∏–Ω–≥ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞—É–∑–∞:** –í —Ä—É—á–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –ø–∞—É–∑–∞ **1 —Å–µ–∫—É–Ω–¥–∞** –≤–º–µ—Å—Ç–æ 60 —Å–µ–∫—É–Ω–¥

3. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–º–ø—Ç—É 9.7:**

   > "–ï—Å–ª–∏ recipients > 150: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sendBulkEmails —Å –±–∞—Ç—á–∏–Ω–≥–æ–º..."

4. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ UI:** –¢–µ–∫—Å—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —Å–æ–æ–±—â–∞–ª–∏ –æ –ø–∞—É–∑–µ –≤ 1 —Å–µ–∫—É–Ω–¥—É, —Ö–æ—Ç—è —Ä–µ–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 60 —Å–µ–∫—É–Ω–¥

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ `sendBulkEmails`

```typescript
// –ë—ã–ª–æ:
import { sendEmail } from '$lib/server/email';

// –°—Ç–∞–ª–æ:
import { sendEmail, sendBulkEmails } from '$lib/server/email';
```

### 2. –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç

–£–±—Ä–∞–Ω—ã –∂—ë—Å—Ç–∫–æ –ø—Ä–æ—à–∏—Ç—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã:

```typescript
// –£–î–ê–õ–ï–ù–û:
const EMAIL_BULK_CHUNK = 50;
const EMAIL_BULK_PAUSE_MS = 1000;
```

### 3. –£–ø—Ä–æ—â–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

```typescript
// –ë–´–õ–û: —Ä—É—á–Ω–æ–π –±–∞—Ç—á–∏–Ω–≥ —Å —Ü–∏–∫–ª–∞–º–∏ –∏ –∂—ë—Å—Ç–∫–æ –ø—Ä–æ—à–∏—Ç—ã–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
if (recipients.length > EMAIL_BULK_CHUNK) {
	const batches = [];
	for (let i = 0; i < recipients.length; i += EMAIL_BULK_CHUNK) {
		batches.push(recipients.slice(i, i + EMAIL_BULK_CHUNK));
	}
	// ... —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞—Ç—á–µ–π
}

// –°–¢–ê–õ–û: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
if (recipients.length > 150) {
	const bulk = await sendBulkEmails(
		recipients.map((r) => r.email),
		subject,
		text,
		platform!.env
	);
	sent = bulk.success;
	failed = bulk.failed;
} else {
	// –ü—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª—è –º–∞–ª—ã—Ö —Å–ø–∏—Å–∫–æ–≤ (<=150)
	const results = await Promise.allSettled(
		recipients.map((recipient) => sendEmail(recipient.email, subject, text, platform!.env))
	);
	// ...
}
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤

–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ–∫—Å—Ç—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –≤–æ **–≤—Å–µ—Ö 4 —è–∑—ã–∫–∞—Ö** (de, en, ru, uk):

**–ë—ã–ª–æ:**

```json
"batching_description": "–†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–∞—Å—Ç—è–º–∏ (–ø–æ 50 –ø–∏—Å–µ–º)
—Å –ø–∞—É–∑–æ–π –≤ 1 —Å–µ–∫—É–Ω–¥—É –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏..."
```

**–°—Ç–∞–ª–æ:**

```json
"batching_description": "–†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–∞—Å—Ç—è–º–∏ (–ø–æ 50 –ø–∏—Å–µ–º)
—Å –ø–∞—É–∑–æ–π –≤ 60 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏ –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ email-—Å–µ—Ä–≤–∏—Å–∞.
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ .env (EMAIL_BULK_CHUNK, EMAIL_BULK_PAUSE_MS)."
```

---

## üì¶ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/routes/api/admin/newsletter/send/+server.ts`**
   - –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ `sendBulkEmails`
   - –£–¥–∞–ª–µ–Ω—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã EMAIL_BULK_CHUNK –∏ EMAIL_BULK_PAUSE_MS
   - –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –±–∞—Ç—á–∏–Ω–≥–∞ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)

2. **`static/translations/de.json`**
   - –û–±–Ω–æ–≤–ª—ë–Ω `admin.newsletter.batching_description`

3. **`static/translations/en.json`**
   - –û–±–Ω–æ–≤–ª—ë–Ω `admin.newsletter.batching_description`

4. **`static/translations/ru.json`**
   - –û–±–Ω–æ–≤–ª—ë–Ω `admin.newsletter.batching_description`

5. **`static/translations/uk.json`**
   - –û–±–Ω–æ–≤–ª—ë–Ω `admin.newsletter.batching_description`

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

‚úÖ **DRY –ø—Ä–∏–Ω—Ü–∏–ø:** –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ –±–∞—Ç—á–∏–Ω–≥–∞  
‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ env (EMAIL_BULK_CHUNK, EMAIL_BULK_PAUSE_MS)  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –ø–∞—É–∑–∞ 60 —Å–µ–∫—É–Ω–¥ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ blacklist  
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏—è `sendBulkEmails` –ª–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —á–∞–Ω–∫–∞–º  
‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** UI –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ:

- **–ï—Å–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π ‚â§ 150:** –ø—Ä—è–º–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (Promise.allSettled)
- **–ï—Å–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π > 150:** –±–∞—Ç—á–∏–Ω–≥ —á–µ—Ä–µ–∑ `sendBulkEmails`:
  - –ß–∞–Ω–∫–∏ –ø–æ 50 –ø–∏—Å–µ–º (–∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ env.EMAIL_BULK_CHUNK)
  - –ü–∞—É–∑–∞ 60 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏ (–∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ env.EMAIL_BULK_PAUSE_MS)
  - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–∞—Ç—á–∏–Ω–≥–∞ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `.env`:

```env
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏—Å–µ–º –≤ –æ–¥–Ω–æ–º —á–∞–Ω–∫–µ (–¥–µ—Ñ–æ–ª—Ç: 50)
EMAIL_BULK_CHUNK=50

# –ü–∞—É–∑–∞ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (–¥–µ—Ñ–æ–ª—Ç: 60000 = 1 –º–∏–Ω—É—Ç–∞)
EMAIL_BULK_PAUSE_MS=60000
```

üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ blacklist –ø–æ—á—Ç–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Email Module Documentation](../../features/email/README.md)
- [Newsletter Feature](../../features/admin/README.md#newsletter)
- [Bulk Email Implementation](../../features/email/IMPLEMENTATION_SUMMARY.md)
