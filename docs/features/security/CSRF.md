# üõ°Ô∏è CSRF –∑–∞—â–∏—Ç–∞ (Cross-Site Request Forgery)

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ CSRF –∑–∞—â–∏—Ç—ã —á–µ—Ä–µ–∑ double-submit cookie pattern –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Berufsorientierung.

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã](#–ø—Ä–∏–Ω—Ü–∏–ø-—Ä–∞–±–æ—Ç—ã)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è cookie](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-cookie)
- [–ü—Ä–∏–º–µ—Ä—ã](#–ø—Ä–∏–º–µ—Ä—ã)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

## üîê –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

### Double-Submit Cookie Pattern

1. **GET –∑–∞–ø—Ä–æ—Å**: –°–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π CSRF —Ç–æ–∫–µ–Ω –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ –≤ httpOnly cookie
2. **POST/PUT/DELETE –∑–∞–ø—Ä–æ—Å**: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ—Ç –∂–µ —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-CSRF-Token` –∏–ª–∏ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã `_csrf`
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –°–µ—Ä–≤–µ—Ä —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ cookie —Å —Ç–æ–∫–µ–Ω–æ–º –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç server-side —Å–µ—Å—Å–∏–π
- ‚úÖ **Stateless** - –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è Cloudflare Workers
- ‚úÖ **SameSite –∑–∞—â–∏—Ç–∞** - cookie –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å cross-origin –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - —Ç–æ–∫–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º GET –∑–∞–ø—Ä–æ—Å–µ

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Middleware: `src/lib/server/middleware/csrf.ts`

```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (32 –±–∞–π—Ç–∞)
generateCsrfToken(): string

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSRF cookie –Ω–∞ GET –∑–∞–ø—Ä–æ—Å–∞—Ö
ensureCsrfCookie(event: RequestEvent): string

// –ü—Ä–æ–≤–µ—Ä–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞ –Ω–∞ POST/PUT/DELETE –∑–∞–ø—Ä–æ—Å–∞—Ö
verifyCsrf(event: RequestEvent): Promise<void>
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: `src/hooks.server.ts`

```typescript
// –ù–∞ –∫–∞–∂–¥—ã–π GET –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç/–ø–æ–ª—É—á–∞–µ—Ç CSRF —Ç–æ–∫–µ–Ω
// 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie
// 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ event.locals.csrfToken
```

### –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints

–í—Å–µ API endpoints —Å –º—É—Ç–∏—Ä—É—é—â–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –≤—ã–∑—ã–≤–∞—é—Ç `verifyCsrf(event)`:

- `POST /api/auth/register`
- `POST /api/auth/login`
- `POST /api/auth/logout`
- `POST /api/events/register`
- `PUT /api/profile/update`
- –ò –≤—Å–µ –Ω–æ–≤—ã–µ POST/PUT/DELETE endpoints

## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í API endpoints

```typescript
import { verifyCsrf } from '$lib/server/middleware/csrf';

export async function POST(event: RequestEvent) {
	try {
		// –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –º—É—Ç–∏—Ä—É—é—â–µ–≥–æ endpoint
		await verifyCsrf(event);

		// –í–∞—à–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞...
	} catch (error) {
		// CSRF –æ—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 403
		throw errors.forbidden('Invalid CSRF token');
	}
}
```

### –í +page.server.ts

```typescript
import type { ServerLoad } from '@sveltejs/kit';

export const load: ServerLoad = async ({ locals }) => {
	return {
		// –ü–µ—Ä–µ–¥–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É
		csrfToken: locals.csrfToken,
	};
};
```

### –í —Ñ–æ—Ä–º–∞—Ö Svelte

```svelte
<script lang="ts">
	export let data: { csrfToken?: string };
</script>

<form on:submit={handleSubmit}>
	<!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –±–µ–∑-JS fallback -->
	{#if data.csrfToken}
		<input type="hidden" name="_csrf" value={data.csrfToken} />
	{/if}

	<!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
</form>
```

### –í fetch –∑–∞–ø—Ä–æ—Å–∞—Ö

```typescript
// –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–≥–æ–ª–æ–≤–æ–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
const response = await fetch('/api/endpoint', {
	method: 'POST',
	headers: {
		'Content-Type': 'application/json',
		...(data.csrfToken && { 'X-CSRF-Token': data.csrfToken }),
	},
	body: JSON.stringify(formData),
});

// –í–∞—Ä–∏–∞–Ω—Ç 2: –í —Ç–µ–ª–µ JSON (fallback)
const response = await fetch('/api/endpoint', {
	method: 'POST',
	headers: { 'Content-Type': 'application/json' },
	body: JSON.stringify({
		...formData,
		csrfToken: data.csrfToken,
	}),
});
```

## üç™ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è cookie

### –ê—Ç—Ä–∏–±—É—Ç—ã CSRF cookie

```typescript
// –ò–º—è cookie
const COOKIE_NAME = 'csrf_token';

// –ê—Ç—Ä–∏–±—É—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
{
  path: '/',              // –î–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
  maxAge: 7200,          // 2 —á–∞—Å–∞ –∂–∏–∑–Ω–∏
  sameSite: 'lax',       // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF, –Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—ã—á–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
  secure: !dev,          // HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, HTTP –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
  httpOnly: true         // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS - –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ JavaScript
}
```

### –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?

- **`sameSite: 'lax'`** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É cookie –ø—Ä–∏ cross-origin POST –∑–∞–ø—Ä–æ—Å–∞—Ö
- **`httpOnly: true`** - –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç XSS –∞—Ç–∞–∫ (cookie –Ω–µ–ª—å–∑—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ JS)
- **`secure: !dev`** - –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É —Ç–æ–ª—å–∫–æ –ø–æ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- **`maxAge: 7200`** - —Ä–∞–∑—É–º–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —É–¥–æ–±—Å—Ç–≤–æ–º

## üí° –ü—Ä–∏–º–µ—Ä—ã

### –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

```bash
# 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
GET /register
‚Üí –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è cookie: csrf_token=abc123...
‚Üí –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω: { csrfToken: "abc123..." }

# 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º—É
POST /api/auth/register
Headers: X-CSRF-Token: abc123...
Cookies: csrf_token=abc123...
‚Üí –¢–æ–∫–µ–Ω—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚úÖ ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
```

### –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è CSRF –∞—Ç–∞–∫–∞

```bash
# –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —Å–æ–∑–¥–∞–µ—Ç —Ñ–∏—à–∏–Ω–≥–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
GET evil-site.com
‚Üí –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ cookie csrf_token –∏–∑-–∑–∞ SameSite

# –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –æ—Ç –∏–º–µ–Ω–∏ –∂–µ—Ä—Ç–≤—ã
POST https://berufsorientierung.app/api/auth/register
‚Üí –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç X-CSRF-Token –∑–∞–≥–æ–ª–æ–≤–æ–∫
‚Üí Cookie csrf_token –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (SameSite)
‚Üí verifyCsrf() –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç 403 Forbidden ‚ùå
```

### –û—Ç–ª–∞–¥–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

```javascript
// –í browser console –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ cookie
document.cookie;
// ‚Üí "csrf_token=abc123...; Path=/; SameSite=Lax"

// –ù–û –Ω–µ–ª—å–∑—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑-–∑–∞ httpOnly ‚úÖ
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

- **CSRF –∞—Ç–∞–∫–∏** - –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ double-submit pattern + SameSite
- **Timing attacks** - constant-time —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ `constantTimeEqual()`
- **XSS –∞—Ç–∞–∫–∏** - httpOnly cookie –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ JavaScript
- **Session fixation** - —Ç–æ–∫–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º GET –∑–∞–ø—Ä–æ—Å–µ

### –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–π–∫–æ—Å—Ç—å

```typescript
// 32 –±–∞–π—Ç–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö = 256 –±–∏—Ç —ç–Ω—Ç—Ä–æ–ø–∏–∏
const bytes = new Uint8Array(32);
crypto.getRandomValues(bytes);

// Base64URL –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è URL –∏ —Ñ–æ—Ä–º)
// –†–µ–∑—É–ª—å—Ç–∞—Ç: 43 —Å–∏–º–≤–æ–ª–∞ base64url —Å—Ç—Ä–æ–∫–∏
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
// –í—Å–µ CSRF –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –Ω–æ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –¥–µ—Ç–∞–ª–∏
console.error('[Endpoint] CSRF verification failed:', error);
throw errors.forbidden('Invalid CSRF token');

// –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ–±—â–∏–π 403 –æ—Ç–≤–µ—Ç –±–µ–∑ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
```

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º

### ‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å

1. **–í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—Ç—å** `verifyCsrf(event)` –≤ –Ω–∞—á–∞–ª–µ POST/PUT/DELETE endpoints
2. **–ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–∫–µ–Ω** —á–µ—Ä–µ–∑ `locals.csrfToken` –≤ load —Ñ—É–Ω–∫—Ü–∏—è—Ö —Å—Ç—Ä–∞–Ω–∏—Ü —Å —Ñ–æ—Ä–º–∞–º–∏
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫** `X-CSRF-Token` –¥–ª—è fetch –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
4. **–î–æ–±–∞–≤–ª—è—Ç—å —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ** `_csrf` –¥–ª—è –±–µ–∑-JS fallback
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** CSRF –∑–∞—â–∏—Ç—É –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö

### ‚ùå –ß–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å

1. **–ù–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å** –ø—Ä–æ–≤–µ—Ä–∫—É CSRF –≤ –º—É—Ç–∏—Ä—É—é—â–∏—Ö endpoints
2. **–ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å** CSRF —Ç–æ–∫–µ–Ω –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)
3. **–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** —Ç–æ–∫–µ–Ω –∏–∑ localStorage/sessionStorage (–¥–æ—Å—Ç—É–ø–µ–Ω XSS)
4. **–ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å** CSRF —Ç–æ–∫–µ–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª—å/—Ñ–∞–π–ª—ã
5. **–ù–µ –∑–∞–±—ã–≤–∞—Ç—å** –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö endpoints

### üîÑ –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –Ω–æ–≤—ã—Ö endpoints

```typescript
// –®–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ API endpoint
export async function POST(event: RequestEvent) {
	try {
		// 1. CSRF –ø—Ä–æ–≤–µ—Ä–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
		await verifyCsrf(event);

		// 2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
		const authResult = await requireAuth(event);

		// 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
		const validatedData = schema.parse(await event.request.json());

		// 4. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
		// ...
	} catch (error) {
		return handleApiError(error);
	}
}
```

## üí° –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### ‚úÖ Zod –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–∏–ø–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø–æ–ª—è

–í—Å–µ —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Zod —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π:

```typescript
// csrfToken –≤ JSON —Ç–µ–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
const validatedData = userRegistrationSchema.parse({
	email: 'test@example.com',
	password: 'password123',
	csrfToken: 'abc123...', // ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—Å—è Zod
});
// Result: { email: "test@example.com", password: "password123" }
```

**–≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ** - CSRF —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è middleware, –∞ –∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

### üõ°Ô∏è –î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞ - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω

–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ **–ò –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –ò –≤ —Ç–µ–ª–µ** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:

```typescript
// ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –æ—Ç–ø—Ä–∞–≤–∫–∏
const response = await fetch('/api/endpoint', {
	method: 'POST',
	headers: {
		'Content-Type': 'application/json',
		'X-CSRF-Token': data.csrfToken, // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±
	},
	body: JSON.stringify({
		...formData,
		csrfToken: data.csrfToken, // Fallback + –±–µ–∑-JS –ø–æ–¥–¥–µ—Ä–∂–∫–∞
	}),
});
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ middleware:**

1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫ `X-CSRF-Token`** - –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö SPA
2. **–ü–æ–ª–µ `csrfToken` –≤ JSON** - fallback –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
3. **–ü–æ–ª–µ `_csrf` –≤ FormData** - fallback –¥–ª—è –±–µ–∑-JS —Ñ–æ—Ä–º

### üîÑ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∞

**–í—Å–µ –Ω–æ–≤—ã–µ POST/PUT/DELETE endpoints:**

```typescript
export async function POST(event: RequestEvent) {
	// ‚úÖ –í–°–ï–ì–î–ê –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º
	await verifyCsrf(event);
	// –î–∞–ª–µ–µ –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞...
}
```

**–í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ñ–æ—Ä–º–∞–º–∏:**

```typescript
// +page.server.ts
export const load: ServerLoad = async ({ locals }) => {
	return {
		csrfToken: locals.csrfToken, // ‚úÖ –í–°–ï–ì–î–ê –ø–µ—Ä–µ–¥–∞–µ–º
	};
};
```

**–í—Å–µ —Ñ–æ—Ä–º—ã:**

```svelte
<!-- ‚úÖ –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –±–µ–∑-JS -->
{#if data.csrfToken}
	<input type="hidden" name="_csrf" value={data.csrfToken} />
{/if}
```

–°–æ–±–ª—é–¥–µ–Ω–∏–µ —ç—Ç–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—É—é CSRF –∑–∞—â–∏—Ç—É –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

---

**–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**

- [auth/MIDDLEWARE.md](../auth/MIDDLEWARE.md) - Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [validation/README.md](../validation/README.md) - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [../../development/fixes/AUTH_CLOUDFLARE_COMPATIBILITY.md](../../development/fixes/AUTH_CLOUDFLARE_COMPATIBILITY.md) - –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Cloudflare Workers

[‚Üê –ù–∞–∑–∞–¥ –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É](../README.md)
