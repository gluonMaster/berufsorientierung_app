# R2 Storage Utilities

Утилиты для работы с Cloudflare R2 Storage.

## Функции

### getR2Bucket

Получает R2 bucket из platform environment.

```typescript
import { getR2Bucket } from '$lib/server/storage/r2';

const bucket = getR2Bucket(platform);
```

**Параметры:**

- `platform: any` - Platform объект из SvelteKit (содержит env)

**Возвращает:** `R2Bucket` - R2 bucket инстанс

**Бросает:** `Error` если R2_BUCKET недоступен в platform.env

### uploadFile

Загружает файл в R2 bucket с долгосрочным кэшированием (1 год).

```typescript
import { getR2Bucket, uploadFile } from '$lib/server/storage/r2';

const bucket = getR2Bucket(platform);
const qrData = new Uint8Array([...]); // Данные QR-кода

await uploadFile(
	bucket,
	'qr/telegram-123.png',
	qrData,
	'image/png'
);
```

**Параметры:**

- `bucket: R2Bucket` - R2 Bucket инстанс
- `key: string` - Ключ (путь) файла в bucket
- `data: Uint8Array` - Содержимое файла
- `contentType: string` - MIME тип файла (например, 'image/png')

**Возвращает:** `Promise<void>`

**Cache Control:** Автоматически устанавливается `public, max-age=31536000` (1 год)

### deleteFile

Удаляет файл из R2 bucket (идемпотентная операция).

```typescript
import { getR2Bucket, deleteFile } from '$lib/server/storage/r2';

const bucket = getR2Bucket(platform);
await deleteFile(bucket, 'qr/telegram-123.png');
```

**Параметры:**

- `bucket: R2Bucket` - R2 Bucket инстанс
- `key: string` - Ключ (путь) файла в bucket

**Возвращает:** `Promise<void>`

**Важно:** Не бросает ошибку если файл не существует

### getPublicUrl

Формирует публичный URL для файла в R2.

```typescript
import { getPublicUrl } from '$lib/server/storage/r2';

const url = getPublicUrl('qr/telegram-123.png', env.R2_PUBLIC_URL);
console.log(url);
// Output: https://bucket.r2.dev/qr/telegram-123.png
```

**Параметры:**

- `key: string` - Ключ (путь) файла в bucket
- `publicUrl: string` - Публичный URL bucket из env.R2_PUBLIC_URL

**Возвращает:** `string` - Полный публичный URL файла

**Примечание:** Автоматически обрабатывает trailing/leading slashes

## Использование в SvelteKit

### Полный пример: Загрузка QR-кода

```typescript
import type { RequestHandler } from './$types';
import { getR2Bucket, uploadFile, getPublicUrl } from '$lib/server/storage/r2';
import QRCode from 'qrcode';

export const POST: RequestHandler = async ({ platform, request }) => {
	try {
		// 1. Получаем bucket
		const bucket = getR2Bucket(platform);

		// 2. Генерируем QR-код
		const { url } = await request.json();
		const qrBuffer = await QRCode.toBuffer(url, {
			errorCorrectionLevel: 'M',
			type: 'png',
			width: 300,
		});

		// 3. Загружаем в R2
		const key = `qr/telegram-${Date.now()}.png`;
		const qrData = new Uint8Array(qrBuffer);
		await uploadFile(bucket, key, qrData, 'image/png');

		// 4. Получаем публичный URL
		const publicUrl = getPublicUrl(key, platform.env.R2_PUBLIC_URL);

		return new Response(JSON.stringify({ url: publicUrl }), {
			headers: { 'Content-Type': 'application/json' },
		});
	} catch (error) {
		console.error('Failed to upload QR code:', error);
		return new Response('Internal Server Error', { status: 500 });
	}
};
```

### В API routes (+server.ts)

```typescript
import type { RequestHandler } from './$types';
import { getR2Bucket, deleteFile } from '$lib/server/storage/r2';

export const DELETE: RequestHandler = async ({ platform, params }) => {
	try {
		const bucket = getR2Bucket(platform);
		await deleteFile(bucket, `qr/${params.filename}`);

		return new Response('Deleted', { status: 200 });
	} catch (error) {
		console.error('Delete failed:', error);
		return new Response('Internal Server Error', { status: 500 });
	}
};
```

### В server load функциях (+page.server.ts)

```typescript
import type { PageServerLoad } from './$types';
import { getR2Bucket, getPublicUrl } from '$lib/server/storage/r2';

export const load: PageServerLoad = async ({ platform }) => {
	const bucket = getR2Bucket(platform);
	const publicUrl = platform.env.R2_PUBLIC_URL;

	// Формируем URL для отображения
	const qrUrl = getPublicUrl('qr/telegram-123.png', publicUrl);

	return { qrUrl };
};
```

## Конфигурация

### wrangler.toml

```toml
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "berufsorientierung-qr-codes"
preview_bucket_name = "berufsorientierung-qr-codes-preview"
```

### Environment Variables

```bash
# .dev.vars (локальная разработка)
R2_PUBLIC_URL=http://localhost:8787

# Production (через Cloudflare Dashboard или wrangler secret)
R2_PUBLIC_URL=https://cdn.berufsorientierung.com
```

### .env.example

```env
# R2 Storage (Cloudflare)
R2_PUBLIC_URL=https://your-bucket.r2.dev
```

## Важные замечания

1. **Получение bucket**: Всегда используйте `getR2Bucket(platform)` вместо прямого обращения к `platform.env.R2_BUCKET` - это обеспечивает проверку наличия bucket

2. **Cache Control**: Файлы загружаются с заголовком `Cache-Control: public, max-age=31536000` (1 год) - подходит для статических QR-кодов

3. **Идемпотентность**: `deleteFile()` не бросает ошибку если файл не существует - безопасно вызывать многократно

4. **URL обработка**: `getPublicUrl()` автоматически обрабатывает trailing/leading slashes в обоих параметрах

5. **Типы данных**: `uploadFile()` принимает `Uint8Array` - при работе с Buffer используйте `new Uint8Array(buffer)`

6. **Публичный доступ**: R2 bucket должен быть настроен на публичный доступ через:
   - Custom Domain (рекомендуется для production)
   - R2.dev subdomain (для разработки)

## Интеграция с QR-кодами

Типичный workflow для генерации и хранения QR-кодов:

```typescript
import { getR2Bucket, uploadFile, getPublicUrl } from '$lib/server/storage/r2';
import QRCode from 'qrcode';

async function generateAndUploadQR(
	platform: App.Platform,
	eventId: number,
	type: 'telegram' | 'whatsapp',
	link: string
): Promise<string> {
	// 1. Генерируем QR-код
	const qrBuffer = await QRCode.toBuffer(link, {
		errorCorrectionLevel: 'M',
		type: 'png',
		width: 300,
	});

	// 2. Получаем bucket
	const bucket = getR2Bucket(platform);

	// 3. Загружаем в R2
	const key = `qr/${type}-${eventId}.png`;
	await uploadFile(bucket, key, new Uint8Array(qrBuffer), 'image/png');

	// 4. Возвращаем публичный URL
	return getPublicUrl(key, platform.env.R2_PUBLIC_URL);
}
```

## Очистка при удалении события

```typescript
import { getR2Bucket, deleteFile } from '$lib/server/storage/r2';
import { getEventById } from '$lib/server/db/events';

async function cleanupEventQRCodes(platform: App.Platform, eventId: number): Promise<void> {
	const event = await getEventById(db, eventId);
	if (!event) return;

	const bucket = getR2Bucket(platform);

	// Удаляем QR-коды (если они есть)
	if (event.qr_telegram_url) {
		// Извлекаем key из URL
		const url = new URL(event.qr_telegram_url);
		const key = url.pathname.substring(1); // Убираем начальный /
		await deleteFile(bucket, key);
	}

	if (event.qr_whatsapp_url) {
		const url = new URL(event.qr_whatsapp_url);
		const key = url.pathname.substring(1);
		await deleteFile(bucket, key);
	}
}
```

## Типы

Импортируются из `@cloudflare/workers-types`:

```typescript
import type { R2Bucket } from '@cloudflare/workers-types';
```

- `R2Bucket` - Cloudflare R2 Bucket инстанс с методами put/get/delete/head
