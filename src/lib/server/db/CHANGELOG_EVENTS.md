# CHANGELOG - Events Database Utilities

## 2025-10-22 - Создание модуля Events

### Добавлено

✅ **Файл `src/lib/server/db/events.ts`** - Полный набор утилит для работы с мероприятиями:

#### Основные CRUD операции:

- `createEvent()` - Создание мероприятия со статусом 'draft'
- `updateEvent()` - Частичное обновление мероприятия
- `deleteEvent()` - Удаление мероприятия с каскадным удалением полей
- `getEventById()` - Получение мероприятия по ID с подсчётом участников

#### Получение списков:

- `getAllEvents()` - Все мероприятия с фильтрацией и пагинацией
- `getActiveEvents()` - Только активные и предстоящие мероприятия
- `getPastEvents()` - Прошедшие мероприятия

#### Управление статусами:

- `publishEvent()` - Публикация мероприятия (draft → active) с валидацией
- `cancelEvent()` - Отмена мероприятия с указанием причины

#### Дополнительные функции:

- `getEventWithFields()` - Получение мероприятия с дополнительными полями (JOIN)

### Обновлено

✅ **Файл `src/lib/server/db/index.ts`** - Добавлены экспорты всех функций модуля events

### Документация

✅ **Файл `src/lib/server/db/README_EVENTS.md`** - Подробная документация с примерами использования всех функций

### Тестирование

✅ **Файл `tests/unit/db-events.test.ts`** - 13 unit-тестов:

- Создание мероприятий с обязательными и дополнительными полями
- Валидация статусов и переходов
- Мультиязычность (de/en/ru/uk)
- Типы дополнительных полей
- Подсчёт активных регистраций
- Обработка дат и сортировка

**Результат тестов:** ✅ 13/13 passed

### Особенности реализации

1. **Prepared Statements**: Все SQL запросы используют параметризованные запросы для защиты от SQL injection

2. **Автоматический подсчёт участников**: В каждом запросе к мероприятию добавляется поле `current_participants` через LEFT JOIN с таблицей registrations

3. **Каскадное удаление**: Дополнительные поля удаляются автоматически благодаря ON DELETE CASCADE в схеме БД

4. **Мультиязычность**: Поддержка 4 языков (de/en/ru/uk) с fallback на немецкий

5. **Валидация при публикации**: Функция `publishEvent()` проверяет обязательные поля перед переводом в статус 'active'

6. **Динамическое обновление**: Функция `updateEvent()` строит SQL запрос на основе переданных полей (partial update)

7. **Обработка ошибок**: Все функции оборачивают ошибки в понятные сообщения с контекстом

## 2025-10-22 (Исправления) - Улучшения согласно промпту

### Исправлено

✅ **deleteEvent** - Добавлено автоматическое удаление QR-кодов из R2:

- Добавлен опциональный параметр `r2Bucket?: R2Bucket`
- Перед удалением записи из БД извлекаются URL QR-кодов (`qr_telegram_url`, `qr_whatsapp_url`)
- QR-коды удаляются из R2 через утилиту `deleteFilesByUrls()`
- Только после этого удаляется запись из БД

✅ **updateEvent** - Гарантированное обновление `updated_at`:

- Удалено условие `if (updateFields.length > 1)`
- Теперь `UPDATE` запрос выполняется всегда, даже если обновляется только `updated_at`
- Это гарантирует обновление `updated_at` при изменении только `additional_fields`

✅ **cancelEvent** - Использование параметра `cancelledBy`:

- Добавлено логирование действия администратора в таблицу `activity_log`
- Записывается: ID администратора, тип действия `event_cancelled`, детали (ID мероприятия, название, причина)
- Это обеспечивает аудит действий и соответствие GDPR compliance

### Добавлено

✅ **Файл `src/lib/server/storage/r2.ts`** - Утилиты для работы с R2:

- `deleteFileByUrl()` - Удаление файла по URL
- `deleteFilesByUrls()` - Удаление нескольких файлов
- `uploadFile()` - Загрузка файла в R2
- `fileExists()` - Проверка существования файла

### Обновлено

✅ **Документация `README_EVENTS.md`**:

- Обновлён пример использования `deleteEvent()` с параметром `r2Bucket`
- Добавлено описание автоматического логирования в `cancelEvent()`
- Расширен раздел "Важные замечания"

### TODO

⚠️ **Важно для следующих этапов:**

1. После отмены мероприятия (cancelEvent) нужно отправить email всем зарегистрированным участникам (реализуется в модуле email)

2. Добавить функцию для массового экспорта/импорта мероприятий (JSON)

### Зависимости

- TypeScript types из `$lib/types/event`
- D1Database из `@cloudflare/workers-types`
- SQLite БД согласно схеме в `migrations/0001_initial.sql`

### Совместимость

- ✅ Cloudflare D1 (SQLite)
- ✅ SvelteKit
- ✅ TypeScript 5.x
- ✅ Vitest для тестирования
